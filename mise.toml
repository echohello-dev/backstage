[tools]
node = "v20"
python = "3.10.11"
yarn = { version = "4.3.1" }

[tasks.init]
description = "Copy missing starter configuration files"
run = '''
#!/usr/bin/env bash
set -euo pipefail
cp -n .env.example .env || true
cp -n app-config.example.yaml app-config.local.yaml || true
'''

[tasks.login-github]
description = "Authenticate against GitHub Container Registry"
run = '''
#!/usr/bin/env bash
set -euo pipefail
if [ -z "${GITHUB_TOKEN:-}" ]; then
  echo "GITHUB_TOKEN is required to login to GitHub Container Registry" >&2
  exit 1
fi
docker login ghcr.io -u default -p "${GITHUB_TOKEN}"
'''

[tasks.install]
description = "Install dependencies and prepare the runtime"
depends = ["init"]
run = '''
#!/usr/bin/env bash
set -euo pipefail
corepack enable
corepack prepare yarn@4.3.1 --activate
if [ "${CI:-false}" = "true" ]; then
  yarn install --immutable
else
  yarn install
fi
'''

[tasks.lint]
description = "Run linting and type checking"
run = '''
#!/usr/bin/env bash
set -euo pipefail
yarn lint:all
yarn tsc
'''

[tasks.test]
description = "Run the test suite"
run = 'yarn test'

[tasks.build]
description = "Build the Backstage Docker image"
depends = ["init"]
run = 'docker compose build backstage'

[tasks.dev]
description = "Start the development stack"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Starting the server at http://localhost:3000"
yarn dev
'''

[tasks.dev-app]
description = "Start the web frontend"
run = 'yarn workspace app start'

[tasks.dev-backend]
description = "Start the backend"
run = 'yarn workspace backend start'

[tasks.dev-docker]
description = "Start Backstage via Docker Compose"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Starting the server at http://localhost:7007 or http://backstage.localhost"
docker compose up
'''

[tasks.logs]
description = "Stream container logs"
run = 'docker compose logs -f'

[tasks.exec]
description = "Open a shell inside the Backstage container"
run = 'docker compose exec backstage bash'

[tasks.plausible-up]
description = "Bring up Plausible with Traefik"
depends = ["init"]
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Plausible is running at http://localhost:8000 or http://plausible.localhost"
echo "Backstage is running at http://localhost:7007 or http://backstage.localhost"
echo "Traefik is running at http://localhost:8080 or http://traefik.localhost"
docker compose -f compose.yaml -f compose.plausible.yaml up -d
'''

[tasks.plausible-down]
description = "Stop the Plausible stack"
run = 'docker compose -f compose.yaml -f compose.plausible.yaml down'

[tasks.up]
description = "Start Backstage with Traefik"
depends = ["init"]
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Backstage is running at http://localhost:7007 or http://backstage.localhost"
echo "Traefik is running at http://localhost:8080 or http://traefik.localhost"
docker compose up -d
'''

[tasks.down]
description = "Stop Backstage and Traefik"
run = 'docker compose down'

[tasks.version]
description = "Print the current calendar-based version"
run = './scripts/version'

[tasks.publish]
description = "Build and push release images"
depends = ["init", "login-github"]
run = './scripts/publish'

[tasks.release]
description = "Tag the repo and create a GitHub release"
run = './scripts/release'

[tasks.undo-release]
description = "Delete the latest release and git tag"
run = './scripts/undo-release'

[tasks.gh-release]
description = "Trigger the release workflow"
run = 'gh workflow run release.yml'
