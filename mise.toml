[tools]
node = "22.11.0"
python = "3.10.12"
yarn = { version = "4.3.1" }
helm = "3.14.1"
k9s = "0.31.9"
kubectl = "1.29.2"
skaffold = "2.10.1"
sops = "3.8.1"
docker-compose = "2.40.3"

[env]
_.file = ".env"

[hooks]
postinstall = '''
install_dir="$HOME/.local/share/mise/installs/docker-compose"
if [ ! -d "$install_dir" ]; then
    exit 0
fi
version="2.40.3"
if [ -d "$install_dir/$version" ]; then
    ln -sf docker-cli-plugin-docker-compose "$install_dir/$version/docker-compose"
fi
'''

[tasks.init]
description = "Copy missing starter configuration files"
run = './scripts/init'

[tasks.login-github]
description = "Authenticate against GitHub Container Registry"
run = './scripts/login-github'

[tasks.install]
description = "Install dependencies and prepare the runtime"
depends = ["init"]
run = './scripts/install'

[tasks.lint]
description = "Run linting and type checking"
run = './scripts/lint'

[tasks.test]
description = "Run the test suite"
run = 'yarn test --watchAll=false'

[tasks.build]
description = "Build the Backstage Docker image"
depends = ["init"]
run = 'docker compose build backstage'

[tasks.dev]
description = "Start the development stack"
run = './scripts/dev'

[tasks.dev-app]
description = "Start the web frontend"
run = 'yarn workspace app start'

[tasks.dev-backend]
description = "Start the backend"
run = 'yarn workspace backend start'

[tasks.dev-docker]
description = "Start Backstage via Docker Compose"
run = './scripts/dev-docker'

[tasks.logs]
description = "Stream container logs"
run = 'docker compose logs -f'

[tasks.exec]
description = "Open a shell inside the Backstage container"
run = 'docker compose exec backstage bash'

[tasks.plausible-up]
description = "Bring up Plausible with Traefik"
depends = ["init"]
run = './scripts/plausible-up'

[tasks.plausible-down]
description = "Stop the Plausible stack"
run = 'docker compose -f compose.yaml -f compose.plausible.yaml down'

[tasks.up]
description = "Start Backstage with Traefik"
depends = ["init"]
run = './scripts/up'

[tasks.down]
description = "Stop Backstage and Traefik"
run = 'docker compose down'

[tasks.version]
description = "Print the current calendar-based version"
run = './scripts/version'

[tasks.publish]
description = "Build and push release images"
depends = ["init", "login-github"]
run = './scripts/publish'

[tasks.release]
description = "Tag the repo and create a GitHub release"
run = './scripts/release'

[tasks.undo-release]
description = "Delete the latest release and git tag"
run = './scripts/undo-release'

[tasks.gh-release]
description = "Trigger the release workflow"
run = 'gh workflow run release.yml'
